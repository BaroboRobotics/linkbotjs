/*! LinkbotJS 01-09-2014 */
function RobotStatus(){var a=this;this.robots=[],this.list=function(){return a.robots},this.acquire=function(b){var c=a.robots.filter(function(a){return"ready"===a.status}),d={robots:[],registered:a.robots.length,ready:c.length};return d.ready>=b&&(rs=c.slice(0,b),rs.map(function(a){return a.status="acquired",a.status}),d.robots=rs.map(function(a){return a.linkbot}),d.ready-=b),d},this.add=function(b){return a.robots.map(function(a){return a.id}).indexOf(b)<0?a.robots.push({status:"new",id:b}):!1},this.remove=function(b){var c=a.robots.map(function(a){return a.id}).indexOf(b);return c>=0?a.robots.splice(c,1):!1},this.relinquish=function(b){var c=a.robots.map(function(a){return a.id}).indexOf(b._id);return c>=0&&"acquired"===a.robots[c].status?(a.robots[c].status="ready",a.robots[c].status):!1},this.ready=function(b,c){var d=a.robots[b];null!==d&&(d.linkbot=c,d.status="ready")},this.fail=function(b){var c=a.robots[b];null!==c&&(c.status="failed")}}function RobotManager(a){function b(a){for(var b=k.dragstart,c=0;c<b.length;c++)b[c](a)}function c(a){for(var b=k.dragover,c=0;c<b.length;c++)b[c](a)}function d(a){for(var b=k.drop,c=0;c<b.length;c++)b[c](a)}function e(a){var b;a.preventDefault(),b=j.element.querySelector("input#robotInput"),j.add(b.value),b.value="",j.connect(),j.redraw()}function f(b){var c,d,e;return b.preventDefault(),e=j.element.querySelector("span"),c=a.querySelector(".robomgr-container"),d=/robomgr-left/.test(e.className),d?(e.className="robomgr-pulloutbtn robomgr-right",c.className="robomgr-container robomgr-container-hidden"):(e.className="robomgr-pulloutbtn robomgr-left",c.className="robomgr-container robomgr-container-open"),b}function g(a,b){a.preventDefault(),j.robots.remove(b);for(var c=k.remove,d=0;d<c.length;d++)c[d](b);j.redraw()}function h(a,e){var f,h;return f=a.createElement("li"),h=a.createElement("span"),h.innerText="[-]",h.setAttribute("class","robomgr--rmBtn robomgr--hoverItem"),h.addEventListener("click",function(a){g(a,e.id)}),f.setAttribute("draggable","true"),f.setAttribute("class","robomgr--"+e.status),f.setAttribute("id","robomgr-id-"+e.id),f.innerText=e.id,f.appendChild(h),f.addEventListener("dragstart",b),f.addEventListener("dragover",c),f.addEventListener("drop",d),f.addEventListener("mouseover",function(a){return a.stopPropagation(),a.currentTarget===f?a.currentTarget.classList.add("robomgr--roboHover"):void 0}),f.addEventListener("mouseout",function(a){return a.stopPropagation(),a.currentTarget===f?a.currentTarget.classList.remove("robomgr--roboHover"):void 0}),f}function i(a){var b,c,d;return c=a.createElement("div"),c.setAttribute("class","robomgr-container robomgr-container-hidden"),c.innerHTML='<div class="robomgr-pullout"><span class="robomgr-pulloutbtn robomgr-right"></span></div><form><div id="robotFormContainer"><label for="robotInput" id="robotInputLabel" class="sr-only">Linkbot ID</label><input name="robotInput" id="robotInput" type="text" placeholder="Linkbot ID" /><button id="robomgr-add">Add</button></div></form><ol></ol>',b=c.querySelector("button"),d=c.querySelector(".robomgr-pullout"),b.addEventListener("click",e),d.addEventListener("click",f),c}var j=this,k={dragstart:[],dragover:[],drop:[],add:[],remove:[]};this.robots=new RobotStatus,this.element=i(a),this.acquire=function(a){var b=j.robots.acquire(a);return j.redraw(),b},this.relinquish=function(a){a.disconnect(),j.robots.relinquish(a),j.redraw()},this.add=function(){var a=1<=arguments.length?[].slice.call(arguments,0):[],b=k.add;a.map(function(a){j.robots.add(a);for(var c=0;c<b.length;c++)b[c](a)})},this.redraw=function(){for(var a=j.element.ownerDocument,b=a.createElement("ol"),c=j.robots.list(),d=0;d<c.length;d++){var e=c[d];b.appendChild(h(a,e))}j.element.replaceChild(b,j.element.querySelector("ol"))},this.connect=function(){for(var a=j.robots.list(),b=[],c=0;c<a.length;c++){var d=a[c];"new"===d.status?(bot=new Linkbot(d.id),b.push(null!==bot._id?j.robots.ready(c,bot):j.robots.fail(c))):b.push(void 0)}return b},this.registerEvent=function(a,b){var c=k[a];c&&c.push(b)},this.unregisterEvent=function(a,b){var c=k[a];c&&c.pop(b)}}function Linkbot(a){function b(a,b,c,d){return null===d&&(d={}),function(e,f,g){return 1===g&&a._id===e&&b===f?c(a,d,{button:f}):void 0}}function c(a,b,c,d){return null===d&&(d={}),function(e,f,g){var h;return a._id===e&&b===f?(h=g-a._wheelPositions[b-1],a._wheelPositions[b-1]=g,c(a,d,{triggerWheel:b,position:g,difference:h})):void 0}}var d=this;if(d._id=a,err=baroboBridge.connectRobot(a),0>err)return void(d._id=null);for(var e=1;3>=e;e++)baroboBridge.setMotorEventThreshold(d._id,e,1e10);if(d._wheelPositions=baroboBridge.getMotorAngles(d._id),d._firmwareVersion=baroboBridge.firmwareVersion(d._id),!baroboBridge.mock){var f=baroboBridge.availableFirmwareVersions();f.indexOf(d._firmwareVersion)<0&&(idAsURI=encodeURIComponent(d._id),baroboBridge.stop(d._id),document.location="../LinkbotUpdate/index.html?badRobot="+idAsURI)}this._wheelRadius=1.75,this.color=function(a,b,c){baroboBridge.setLEDColor(d._id,a,b,c)},this.angularSpeed=function(a,b,c){return null===b&&(b=a),null===c&&(c=a),baroboBridge.angularSpeed(d._id,a,b,c)},this.move=function(a,b,c){return baroboBridge.move(d._id,a,b,c)},this.moveTo=function(a,b,c){return baroboBridge.moveTo(d._id,a,b,c)},this.wheelPositions=function(){return d._wheelPositions=baroboBridge.getMotorAngles(d._id),d._wheelPositions},this.stop=function(){return baroboBridge.stop(d._id)},this.buzzerFrequency=function(a){return baroboBridge.buzzerFrequency(d._id,a)},this.disconnect=function(){return d.stop(),d._id=null,d._id},this.register=function(a){var e,f,g,h,i,j,k,l;if(null!==a.button){i=a.button;for(e in i)__hasProp.call(i,e)&&(f=i[e],g=b(d,parseInt(e),f.callback,f.data),baroboBridge.buttonChanged.connect(g),baroboBridge.enableButtonSignals(d._id))}if(null!==a.wheel){j=a.wheel,k=[];for(l in j)__hasProp.call(j,l)&&(f=j[l],h=parseInt(l),g=c(d,h,f.callback,f.data),baroboBridge.setMotorEventThreshold(d._id,h,f.distance),baroboBridge.motorChanged.connect(g),k.push(baroboBridge.enableMotorSignals(d._id)));return k}},this.unregister=function(){return baroboBridge.motorChanged.disconnect(),baroboBridge.disableMotorSignals(d._id),baroboBridge.buttonChanged.disconnect(),baroboBridge.disableButtonSignals(d._id)}}function Storage(a){var b=a?a:{DBNAME:"robotsdb",DBVER:1,DBDESC:"Robots Database, used for persistance",TABLE:"robots"},c=openDatabase(b.DBNAME,b.DBVER,b.DBDESC,b.DBSIZE);c.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS "+b.TABLE+" (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT unique not null, status INTEGER not null, rorder INTEGER not null)",[],function(){},function(a,b){console.log(b)})}),this.remove=function(a,d){c.transaction(function(c){c.executeSql("DELETE FROM "+b.TABLE+" WHERE name = ?",[a],function(){d(!0)},function(a,b){d(!1,b)})})},this.add=function(a,d,e){c.transaction(function(c){c.executeSql("SELECT COUNT(*) AS c FROM "+b.TABLE,[],function(c,f){c.executeSql("INSERT INTO "+b.TABLE+" (name, status, rorder) values (?,?,?)",[a,d,f.rows.item(0).c],function(){e&&e(!0)},function(a,b){e&&e(!1,b)})},function(a,b){e&&e(!1,b)})})},this.getAll=function(a){c.transaction(function(c){c.executeSql("SELECT * FROM "+b.TABLE+" ORDER BY rorder",[],function(b,c){for(var d=c.rows,e=[],f=0;f<c.rows.length;f++)e.push({id:d.item(f).id,name:d.item(f).name,status:d.item(f).status,order:d.item(f).rorder});a&&a(e)},function(b,c){a&&a([],c)})})},this.printRows=function(){c.transaction(function(a){a.executeSql("SELECT * FROM "+b.TABLE+" ORDER BY rorder",[],function(a,b){for(var c=b.rows,d=0;d<b.rows.length;d++)console.log("ID:"+c.item(d).id+", NAME:"+c.item(d).name+", STATUS:"+c.item(d).status+", ORDER:"+c.item(d).rorder)},function(a,b){console.log(b)})})},this.changePosition=function(a,d,e){a!==d&&c.transaction(function(c){var f=a,g=d;a>d&&(f=d,g=a),c.executeSql("SELECT * from "+b.TABLE+" WHERE rorder BETWEEN ? and ? ORDER BY rorder",[f,g],function(c,f){var g=0,h=-1,i=f.rows;a>d&&(h=1);var j=function(a,b){e&&e(!0,b)},k=function(){e&&e(!1,results)};for(g=0;g<f.rows.length;g++){var l=i.item(g).rorder+h,m=i.item(g).id;i.item(g).rorder==a&&(l=d),c.executeSql("UPDATE "+b.TABLE+" SET rorder = ? WHERE id = ?",[l,m],j,k)}e&&e(!0)},function(a,b){e&&e(!1,b)})})}}baroboBridge=function(a){var b,c,d,e;if(null!==a.baroboBridge)return a.baroboBridge;methods=["angularSpeed","availableFirmwareVersions","buttonChanged","connectRobot","disconnectRobot","enableButtonSignals","enableMotorSignals","disableButtonSignals","disableMotorSignals","firmwareVersion","getMotorAngles","scan","setMotorEventThreshold","stop"],signals=["motorChanged","buttonChanged"],obj={mock:!0};var f=function(){};for(b=0,d=methods.length;d>b;b++)k=methods[b],obj[k]=f;for(c=0,e=signals.length;e>c;c++)k=signals[c],obj[k]={connect:f,disconnect:f};return obj}(this);var Linkbots=function(a,b){function c(a,b){j.getAll(function(c){srcOrder=-1,destOrder=-1;for(var d=0;d<c.length&&(c[d].name===a?srcOrder=c[d].order:c[d].name===b&&(destOrder=c[d].order),!(destOrder>=0&&srcOrder>=0));d++);destOrder>=0&&srcOrder>=0&&j.changePosition(srcOrder,destOrder,function(a){if(a===!0){var b=i.robots.robots.splice(srcOrder,1);i.robots.robots.splice(destOrder,0,b[0])}})})}function d(a){a.dataTransfer.setData("text/html",a.target.innerHTML),a.dataTransfer.effectAllowed="move",k=a.target}function e(a){a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="move"}function f(a){if(a.stopPropagation&&a.stopPropagation(),k!=a.target){var b=k.getAttribute("id").replace(/robomgr-id-/,""),d=a.target.getAttribute("id").replace(/robomgr-id-/,""),e=k.getAttribute("id"),f=k.getAttribute("class");k.setAttribute("id",a.target.getAttribute("id")),k.setAttribute("class",a.target.getAttribute("class")),k.innerHTML=a.target.innerHTML,a.target.setAttribute("id",e),a.target.setAttribute("class",f),a.target.innerHTML=a.dataTransfer.getData("text/html"),c(b,d)}return!1}function g(a){j.add(a,0)}function h(a){j.remove(a)}var i=new RobotManager(b),j=new Storage,k=null;return j.getAll(function(a){for(var b=0;b<a.length;b++)i.add(a[b].name);i.connect(),i.redraw()}),i.registerEvent("dragstart",d),i.registerEvent("dragover",e),i.registerEvent("drop",f),i.registerEvent("add",g),i.registerEvent("remove",h),a.scan=function(){return baroboBridge.scan()},a.managerElement=function(){return i.element},a.acquire=function(a){return i.acquire(a)},a.relinquish=function(a){return i.relinquish(a)},a.managerAdd=function(){var a=1<=arguments.length?[].slice.call(arguments,0):[];return i.add.apply(i,a)},a.managerRedraw=function(){return i.redraw()},a.managerConnect=function(){return i.connect()},a.storage=j,a}(Linkbots||{},document);